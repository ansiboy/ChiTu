"use strict";function _possibleConstructorReturn(self,call){if(!self)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!call||"object"!=typeof call&&"function"!=typeof call?self:call}function _inherits(subClass,superClass){if("function"!=typeof superClass&&null!==superClass)throw new TypeError("Super expression must either be null or a function, not "+typeof superClass);subClass.prototype=Object.create(superClass&&superClass.prototype,{constructor:{value:subClass,enumerable:!1,writable:!0,configurable:!0}}),superClass&&(Object.setPrototypeOf?Object.setPrototypeOf(subClass,superClass):subClass.__proto__=superClass)}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function ajax(url,options){return __awaiter(this,void 0,void 0,regeneratorRuntime.mark(function _callee2(){var response,responseText,p,text,textObject,isJSONContextType,err;return regeneratorRuntime.wrap(function(_context2){for(;;)switch(_context2.prev=_context2.next){case 0:return _context2.next=2,fetch(url,options);case 2:return response=_context2.sent,responseText=response.text(),p=void 0,p="string"==typeof responseText?new Promise(function(reslove,reject){reslove(responseText)}):responseText,_context2.next=8,responseText;case 8:if(text=_context2.sent,textObject=void 0,isJSONContextType=(response.headers.get("content-type")||"").indexOf("json")>=0,textObject=isJSONContextType?JSON.parse(text):text,!(response.status>=300)){_context2.next=19;break}throw err=new Error,err.method=options.method,err.name=""+response.status,err.message=isJSONContextType?textObject.Message||textObject.message:textObject,err.message=err.message||response.statusText,err;case 19:return _context2.abrupt("return",textObject);case 20:case"end":return _context2.stop()}},_callee2,this)}))}function callAjax(url,options,service,error){return new Promise(function(reslove,reject){var timeId=void 0;"get"==options.method&&(timeId=setTimeout(function(){var err=new Error;err.name="timeout",err.message="网络连接超时",reject(err),error.fire(service,err),clearTimeout(timeId)},1e3*chitu.Service.settings.ajaxTimeout)),ajax(url,options).then(function(data){reslove(data),timeId&&clearTimeout(timeId)})["catch"](function(err){reject(err),error.fire(service,err),timeId&&clearTimeout(timeId)})})}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj},_createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}(),__awaiter=function(thisArg,_arguments,P,generator){return new(P||(P=Promise))(function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator["throw"](value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):new P(function(resolve){resolve(result.value)}).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())})},chitu;!function(chitu){var PageMaster=function(){function PageMaster(container,parser){if(_classCallCheck(this,PageMaster),this.pageCreated=chitu.Callbacks(),this.pageLoad=chitu.Callbacks(),this.pageType=chitu.Page,this.pageDisplayType=PageDisplayerImplement,this.cachePages={},this.page_stack=new Array,this.nodes={},this.error=chitu.Callbacks(),this.parser=parser||this.defaultPageNodeParser(),!container)throw chitu.Errors.argumentNull("container");this.parser.actions=this.parser.actions||{},this.container=container}return _createClass(PageMaster,[{key:"defaultPageNodeParser",value:function(){var _this=this,nodes={},p={actions:{},parse:function(pageName){var node=nodes[pageName];if(null==node){var path=("modules_"+pageName).split("_").join("/");node={action:_this.createDefaultAction(path,chitu.loadjs),name:pageName},nodes[pageName]=node}return node}};return p}},{key:"createDefaultAction",value:function(url,loadjs){var _this2=this;return function(page){return __awaiter(_this2,void 0,void 0,regeneratorRuntime.mark(function _callee(){var actionExports,_action,result,action,_action2;return regeneratorRuntime.wrap(function(_context){for(;;)switch(_context.prev=_context.next){case 0:return _context.next=2,loadjs(url);case 2:if(actionExports=_context.sent){_context.next=5;break}throw chitu.Errors.exportsCanntNull(url);case 5:if(_action=actionExports.defalut,null!=_action){_context.next=8;break}throw chitu.Errors.canntFindAction(page.name);case 8:return result=void 0,PageMaster.isClass(_action)?(action=_action,result=new action(page,this)):(_action2=_action,result=_action2(page,this)),_context.abrupt("return",result);case 11:case"end":return _context.stop()}},_callee,this)}))}}},{key:"on_pageCreated",value:function(page){return this.pageCreated.fire(this,page)}},{key:"getPage",value:function(node,values){console.assert(null!=node),values=values||{};var pageName=node.name,cachePage=this.cachePages[pageName];if(null!=cachePage)return cachePage.data=Object.assign(cachePage.data||{},values),{page:cachePage,isNew:!1};var page=this.createPage(pageName,values);return this.cachePages[pageName]=page,this.on_pageCreated(page),{page:page,isNew:!0}}},{key:"createPage",value:function(pageName,values){if(!pageName)throw chitu.Errors.argumentNull("pageName");values=values||{};var element=this.createPageElement(pageName),displayer=new this.pageDisplayType(this);console.assert(null!=this.pageType);var page=new this.pageType({app:this,name:pageName,data:values,displayer:displayer,element:element});return page}},{key:"createPageElement",value:function(pageName){var element=document.createElement(chitu.Page.tagName);return this.container.appendChild(element),element}},{key:"showPage",value:function(pageName,args,rerender){if(args=args||{},rerender=null!=rerender,!pageName)throw chitu.Errors.argumentNull("pageName");var node=this.findSiteMapNode(pageName);if(null==node)throw chitu.Errors.pageNodeNotExists(pageName);if(null!=this.currentPage&&this.currentPage.name==pageName)return this.currentPage;args=args||{};var _getPage=this.getPage(node,args),page=_getPage.page,isNew=_getPage.isNew;if(isNew||rerender){var siteMapNode=this.findSiteMapNode(pageName);if(null==siteMapNode)throw chitu.Errors.pageNodeNotExists(pageName);var action=siteMapNode.action;if(null==action)throw chitu.Errors.actionCanntNull(pageName);action(page,this)}return page.show(),this.pushPage(page),console.assert(page==this.currentPage,"page is not current page"),page}},{key:"closePage",value:function(page){if(null==page)throw chitu.Errors.argumentNull("page");page.close(),delete this.cachePages[page.name],this.page_stack=this.page_stack.filter(function(o){return o!=page})}},{key:"pushPage",value:function(page){this.page_stack.push(page)}},{key:"findSiteMapNode",value:function(pageName){if(this.nodes[pageName])return this.nodes[pageName];var node=null,action=this.parser.actions?this.parser.actions[pageName]:null;return null!=action&&(node={action:action,name:pageName}),null==node&&null!=this.parser.parse&&(node=this.parser.parse(pageName),console.assert(null!=node.action)),null!=node&&(this.nodes[pageName]=node),node}},{key:"closeCurrentPage",value:function(passData){var page=this.page_stack.pop();null!=page&&(this.closePage(page),this.currentPage&&(passData&&(console.assert(null!=this.currentPage.data),this.currentPage.data=Object.assign(this.currentPage.data,passData)),this.currentPage.show()))}},{key:"currentPage",get:function(){return this.page_stack.length>0?this.page_stack[this.page_stack.length-1]:null}},{key:"pageStack",get:function(){return this.page_stack}}]),PageMaster}();PageMaster.isClass=function(){function fnBody(fn){return toString.call(fn).replace(/^[^{]*{\s*/,"").replace(/\s*}[^}]*$/,"")}function isClass(fn){return"function"==typeof fn&&(/^class(\s|\{\}$)/.test(toString.call(fn))||/^.*classCallCheck\(/.test(fnBody(fn)))}var toString=Function.prototype.toString;return isClass}(),chitu.PageMaster=PageMaster}(chitu||(chitu={}));var chitu;!function(chitu){function _parseUrl(app,url){var sharpIndex=url.indexOf("#");if(sharpIndex<0){var _pageName=DefaultPageName;return{pageName:_pageName,values:{}}}var routeString=url.substr(sharpIndex+1);if(!routeString)throw chitu.Errors.canntParseRouteString(url);if(routeString.startsWith("!"))throw chitu.Errors.canntParseRouteString(routeString);var routePath=void 0,search=null,param_spliter_index=routeString.indexOf("?");if(param_spliter_index>0?(search=routeString.substr(param_spliter_index+1),routePath=routeString.substring(0,param_spliter_index)):routePath=routeString,!routePath)throw chitu.Errors.canntParseRouteString(routeString);var values={};search&&(values=pareeUrlQuery(search));var pageName=routePath;return{pageName:pageName,values:values}}function pareeUrlQuery(query){for(var match=void 0,pl=/\+/g,search=/([^&=]+)=?([^&]*)/g,decode=function(s){return decodeURIComponent(s.replace(pl," "))},urlParams={};match=search.exec(query);)urlParams[decode(match[1])]=decode(match[2]);return urlParams}function _createUrl(pageName,params){var path_parts=pageName.split("."),path=path_parts.join("/");if(!params)return"#"+path;var paramsText="";for(var key in params){var value=params[key],type=_typeof(params[key]);"string"==type&&null!=value&&(paramsText=""==paramsText?"?"+key+"="+params[key]:paramsText+("&"+key+"="+params[key]))}return"#"+path+paramsText}var EmtpyStateData="",DefaultPageName="index",Application=function(_chitu$PageMaster){function Application(args){_classCallCheck(this,Application);var _this3=_possibleConstructorReturn(this,(Application.__proto__||Object.getPrototypeOf(Application)).call(this,(args||{}).container||document.body,(args||{}).parser));return _this3._runned=!1,_this3.closeCurrentOnBack=null,_this3.tempPageData=void 0,_this3}return _inherits(Application,_chitu$PageMaster),_createClass(Application,[{key:"parseUrl",value:function(url){var routeData=_parseUrl(this,url);return routeData}},{key:"createUrl",value:function(pageName,values){return _createUrl(pageName,values)}},{key:"run",value:function(){var _this4=this;this._runned||(this.showPageByUrl(location.href,!1),window.addEventListener("popstate",function(){var url=location.href,sharpIndex=url.indexOf("#"),routeString=url.substr(sharpIndex+1);sharpIndex<0||routeString.startsWith("!")||_this4.showPageByUrl(url,!0)}),this._runned=!0)}},{key:"showPageByUrl",value:function(url,fromCache){if(!url)throw chitu.Errors.argumentNull("url");var routeData=this.parseUrl(url);if(null==routeData)throw chitu.Errors.noneRouteMatched(url);var tempPageData=this.fetchTemplatePageData(),result=null;if(1==this.closeCurrentOnBack)this.closeCurrentOnBack=null,null==tempPageData?this.closeCurrentPage():this.closeCurrentPage(tempPageData),result=this.currentPage;else if(0==this.closeCurrentOnBack){this.closeCurrentOnBack=null;var page=this.pageStack.pop();if(null==page)throw new Error("page is null");page.hide(this.currentPage),result=this.currentPage}if(null==result){var args=routeData.values||{};tempPageData&&(args=Object.assign(args,tempPageData)),result=this.showPage(routeData.pageName,args)}return result}},{key:"fetchTemplatePageData",value:function(){if(null==this.tempPageData)return null;var data=this.tempPageData;return this.tempPageData=void 0,data}},{key:"setLocationHash",value:function(url){history.pushState(EmtpyStateData,"",url)}},{key:"redirect",value:function(pageName,args){var result=this.showPage(pageName,args),url=this.createUrl(pageName,args);return this.setLocationHash(url),result}},{key:"forward",value:function(pageName,args){var result=this.showPage(pageName,args,!0),url=this.createUrl(pageName,args);return this.setLocationHash(url),result}},{key:"reload",value:function(pageName,args){var result=this.showPage(pageName,args,!0);return result}},{key:"back",value:function(closeCurrentPage,data){var closeCurrentPageDefault=!0;"object"==("undefined"==typeof closeCurrentPage?"undefined":_typeof(closeCurrentPage))&&(data=closeCurrentPage,closeCurrentPage=null),this.closeCurrentOnBack=null==closeCurrentPage?closeCurrentPageDefault:closeCurrentPage,this.tempPageData=data,history.back()}}]),Application}(chitu.PageMaster);chitu.Application=Application}(chitu||(chitu={}));var chitu;!function(chitu){var Errors=function(){function Errors(){_classCallCheck(this,Errors)}return _createClass(Errors,null,[{key:"pageNodeNotExists",value:function(pageName){var msg="Page node named "+pageName+" is not exists.";return new Error(msg)}},{key:"actionCanntNull",value:function(pageName){var msg="Action of '"+pageName+"' can not be null.";return new Error(msg)}},{key:"argumentNull",value:function(paramName){var msg='The argument "'+paramName+'" cannt be null.';return new Error(msg)}},{key:"modelFileExpecteFunction",value:function(script){var msg='The eval result of script file "'+script+'" is expected a function.';return new Error(msg)}},{key:"paramTypeError",value:function(paramName,expectedType){var msg='The param "'+paramName+'" is expected "'+expectedType+'" type.';return new Error(msg)}},{key:"paramError",value:function(msg){return new Error(msg)}},{key:"pathPairRequireView",value:function(index){var msg='The view value is required for path pair, but the item with index "'+index+'" is miss it.';return new Error(msg)}},{key:"notImplemented",value:function(name){var msg="'The method \""+name+"\" is not implemented.'";return new Error(msg)}},{key:"routeExists",value:function(name){var msg='Route named "'+name+'" is exists.';return new Error(msg)}},{key:"noneRouteMatched",value:function(url){var msg='None route matched with url "'+url+'".',error=new Error(msg);return error}},{key:"emptyStack",value:function(){return new Error("The stack is empty.")}},{key:"canntParseUrl",value:function(url){var msg='Can not parse the url "'+url+'" to route data.';return new Error(msg)}},{key:"canntParseRouteString",value:function(routeString){var msg='Can not parse the route string "'+routeString+'" to route data.;';return new Error(msg)}},{key:"routeDataRequireController",value:function(){var msg='The route data does not contains a "controller" file.';return new Error(msg)}},{key:"routeDataRequireAction",value:function(){var msg='The route data does not contains a "action" file.';return new Error(msg)}},{key:"viewCanntNull",value:function(){var msg="The view or viewDeferred of the page cannt null.";return new Error(msg)}},{key:"createPageFail",value:function(pageName){var msg='Create page "'+pageName+'" fail.';return new Error(msg)}},{key:"actionTypeError",value:function(pageName){var msg="The action in page '"+pageName+"' is expect as function.";return new Error(msg)}},{key:"canntFindAction",value:function(pageName){var msg="Cannt find action in page '"+pageName+"', is the exports has default field?";return new Error(msg)}},{key:"exportsCanntNull",value:function(pageName){var msg="Exports of page '"+pageName+"' is null.";return new Error(msg)}},{key:"scrollerElementNotExists",value:function(){var msg="Scroller element is not exists.";return new Error(msg)}},{key:"resourceExists",value:function(resourceName,pageName){var msg="Rosource '"+resourceName+"' is exists in the resources of page '"+pageName+"'.";return new Error(msg)}},{key:"siteMapRootCanntNull",value:function(){var msg="The site map root node can not be null.";return new Error(msg)}},{key:"duplicateSiteMapNode",value:function(name){return new Error(name)}}]),Errors}();chitu.Errors=Errors}(chitu||(chitu={}));var chitu;!function(chitu){function Callbacks(){return new Callback}function loadjs(path){return new Promise(function(reslove,reject){require([path],function(result){reslove(result)},function(err){reject(err)})})}var Callback=function(){function Callback(){_classCallCheck(this,Callback),this.funcs=new Array}return _createClass(Callback,[{key:"add",value:function(func){this.funcs.push(func)}},{key:"remove",value:function(func){this.funcs=this.funcs.filter(function(o){return o!=func})}},{key:"fire",value:function(){for(var _len=arguments.length,args=Array(_len),_key=0;_key<_len;_key++)args[_key]=arguments[_key];this.funcs.forEach(function(o){return o.apply(void 0,args)})}}]),Callback}();chitu.Callback=Callback,chitu.Callbacks=Callbacks;var ValueStore=function(){function ValueStore(value){_classCallCheck(this,ValueStore),this.items=new Array,this._value=void 0===value?null:value}return _createClass(ValueStore,[{key:"add",value:function(func,sender){return this.items.push({func:func,sender:sender}),func}},{key:"remove",value:function(func){this.items=this.items.filter(function(o){return o.func!=func})}},{key:"fire",value:function(value){this.items.forEach(function(o){return o.func(value,o.sender)})}},{key:"value",get:function(){return void 0===this._value?null:this._value},set:function(value){this._value=value,this.fire(value)}}]),ValueStore}();chitu.ValueStore=ValueStore,chitu.loadjs=loadjs}(chitu||(chitu={}));var chitu;!function(chitu){var Page=function(){function Page(params){_classCallCheck(this,Page),this.data={},this.showing=chitu.Callbacks(),this.shown=chitu.Callbacks(),this.hiding=chitu.Callbacks(),this.hidden=chitu.Callbacks(),this.closing=chitu.Callbacks(),this.closed=chitu.Callbacks(),this._element=params.element,this._app=params.app,this._displayer=params.displayer,this.data=params.data,this._name=params.name}return _createClass(Page,[{key:"on_showing",value:function(){return this.showing.fire(this,this.data)}},{key:"on_shown",value:function(){return this.shown.fire(this,this.data)}},{key:"on_hiding",value:function(){return this.hiding.fire(this,this.data)}},{key:"on_hidden",value:function(){return this.hidden.fire(this,this.data)}},{key:"on_closing",value:function(){return this.closing.fire(this,this.data)}},{key:"on_closed",value:function(){return this.closed.fire(this,this.data)}},{key:"show",value:function(){var _this5=this;this.on_showing();var currentPage=this._app.currentPage;return this==currentPage&&(currentPage=null),this._displayer.show(this,currentPage).then(function(o){_this5.on_shown()})}},{key:"hide",value:function(currentPage){var _this6=this;return this.on_hiding(),this._displayer.hide(this,currentPage).then(function(o){_this6.on_hidden()})}},{key:"close",value:function(){return this.on_closing(),this._element.remove(),this.on_closed(),Promise.resolve()}},{key:"createService",value:function(type){var _this7=this;type=type||chitu.Service;var service=new type;return service.error.add(function(ender,error){_this7._app.error.fire(_this7._app,error,_this7)}),service}},{key:"element",get:function(){return this._element}},{key:"name",get:function(){return this._name}},{key:"app",get:function(){return this._app}}]),Page}();Page.tagName="div",chitu.Page=Page}(chitu||(chitu={}));var PageDisplayerImplement=function(){function PageDisplayerImplement(){_classCallCheck(this,PageDisplayerImplement)}return _createClass(PageDisplayerImplement,[{key:"show",value:function(page,previous){return page.element.style.display="block",null!=previous&&(previous.element.style.display="none"),Promise.resolve()}},{key:"hide",value:function(page,previous){return page.element.style.display="none",null!=previous&&(previous.element.style.display="block"),Promise.resolve()}}]),PageDisplayerImplement}(),chitu;!function(chitu){var Service=function(){function Service(){_classCallCheck(this,Service),this.error=chitu.Callbacks()}return _createClass(Service,[{key:"ajax",value:function(url,options){void 0===options&&(options={});var data=options.data,method=options.method,headers=options.headers||{},body=void 0;if(null!=data){var is_json=(headers["content-type"]||"").indexOf("json")>=0;if(is_json)body=JSON.stringify(data);else{body=new URLSearchParams;for(var key in data)body.append(key,data[key])}}return callAjax(url,{headers:headers,body:body,method:method},this,this.error)}}]),Service}();Service.settings={ajaxTimeout:30},chitu.Service=Service}(chitu||(chitu={}));